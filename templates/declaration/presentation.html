{% extends 'base_tailwind.html' %}
{% block content %}
{% include 'partials/header.html' %}
{% include 'partials/stepper.html' with current_step=1 %}
{% include 'partials/messages.html' %}

<div class="min-h-[calc(100vh-100px)] bg-[#F8FAFC] py-12 px-6 lg:px-10 font-sans">
    <div class="max-w-5xl mx-auto">
        
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-10">
            <div>
                <h1 class="text-3xl font-black text-slate-900 tracking-tight flex items-center gap-3">
                    <span class="p-3 bg-emerald-600 text-white rounded-2xl shadow-lg shadow-emerald-100">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    </span>
                    CONFIGURATION <span class="italic text-emerald-600 uppercase">PÉRIODE</span>
                </h1>
                <p class="text-slate-500 text-sm mt-3 font-medium">
                    Définissez l'intervalle temporel. Le système calculera automatiquement votre <span class="text-slate-900 font-bold underline decoration-emerald-500/30">échéance fiscale</span>.
                </p>
            </div>
        </div>

        <form method="post" class="relative">
            {% csrf_token %}
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                <div class="lg:col-span-2 space-y-6">
                    <div class="bg-white rounded-[2.5rem] border border-slate-100 shadow-sm p-8 md:p-12 transition-all hover:shadow-md">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                            
                            <div class="group">
                                <label for="id_date_debut" class="flex items-center gap-2 text-[10px] font-black uppercase tracking-[0.2em] text-slate-400 mb-4 group-focus-within:text-emerald-600 transition-colors">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                                    Date de début
                                </label>
                                <input type="date" name="date_debut" id="id_date_debut" required
                                    class="w-full bg-slate-50 border-2 border-slate-100 text-slate-900 text-lg font-black rounded-2xl focus:ring-8 focus:ring-emerald-500/5 focus:border-emerald-500 focus:bg-white block p-5 transition-all outline-none">
                            </div>

                            <div class="group">
                                <label for="id_date_fin" class="flex items-center gap-2 text-[10px] font-black uppercase tracking-[0.2em] text-slate-400 mb-4 group-focus-within:text-emerald-600 transition-colors">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                                    Date de fin
                                </label>
                                <input type="date" name="date_fin" id="id_date_fin" required
                                    class="w-full bg-slate-50 border-2 border-slate-100 text-slate-900 text-lg font-black rounded-2xl focus:ring-8 focus:ring-emerald-500/5 focus:border-emerald-500 focus:bg-white block p-5 transition-all outline-none">
                            </div>
                        </div>

                        <div class="mt-10 p-5 bg-amber-50 rounded-2xl border border-amber-100 flex gap-4">
                            <div class="text-amber-500 flex-shrink-0">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>
                            </div>
                            <p class="text-amber-800 text-[11px] leading-relaxed font-medium">
                                <span class="font-black uppercase tracking-widest block mb-1">Rappel Réglementaire</span>
                                Le règlement est attendu au plus tard le <span class="font-black">15 du mois suivant</span> la fin de la période sélectionnée.
                            </p>
                        </div>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="bg-slate-900 rounded-[2.5rem] p-8 text-white shadow-xl relative overflow-hidden">
                        <h3 class="text-[10px] font-black uppercase tracking-[0.2em] text-emerald-400 mb-8">Calcul Automatique</h3>
                        
                        <div class="space-y-8 relative z-10">
                            <div>
                                <span class="text-[9px] font-bold text-slate-400 uppercase">Exercice</span>
                                <input type="number" name="annee" id="id_annee" readonly
                                    class="w-full bg-transparent border-none text-2xl font-black p-0 mt-1 cursor-default outline-none text-white">
                            </div>

                            <div>
                                <span class="text-[9px] font-bold text-slate-400 uppercase">Cycle de Déclaration</span>
                                <select name="periode_type" id="id_periode_type" 
                                    class="w-full bg-transparent border-none text-emerald-400 text-xl font-black p-0 mt-1 appearance-none pointer-events-none outline-none">
                                    <option value="mensuel">Mensuel</option>
                                    <option value="bimestriel">Bimestriel</option>
                                    <option value="trimestriel">Trimestriel</option>
                                </select>
                            </div>

                            <div class="pt-6 border-t border-white/10">
                                <span class="text-[9px] font-bold text-emerald-400 uppercase">Échéance de paiement</span>
                                <input type="date" name="date_limite" id="id_date_limite" readonly
                                    class="w-full bg-transparent border-none text-2xl font-black p-0 mt-1 outline-none text-white">
                            </div>
                        </div>

                        <div class="absolute -right-10 -top-10 w-32 h-32 bg-emerald-500/10 rounded-full blur-3xl"></div>
                    </div>

                    <button type="submit" 
                        class="w-full group bg-emerald-600 hover:bg-emerald-700 text-white p-6 rounded-[2rem] transition-all shadow-xl shadow-emerald-100 flex flex-col items-center gap-2 active:scale-95">
                        <span class="text-[12px] font-black uppercase tracking-[0.3em]">Continuer l'analyse</span>
                        <svg class="w-6 h-6 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M17 8l4 4m0 0l-4 4m4-4H3"/></svg>
                    </button>
                </div>

            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // On récupère l'ID de l'utilisateur pour isoler le stockage
        const userId = "{{ user.id }}";
        const startInput = document.getElementById('id_date_debut');
        const endInput = document.getElementById('id_date_fin');
        const fields = ['id_date_debut', 'id_date_fin'];
        const submitBtn = document.querySelector('button[type="submit"]');

        // Helper pour générer une clé unique par utilisateur
        const getStoreKey = (id) => `user_${userId}_${id}`;
    
        // 1. RESTAURATION : Au chargement, on ne récupère que les données de cet utilisateur
        fields.forEach(id => {
            const savedValue = localStorage.getItem(getStoreKey(id));
            if (savedValue) {
                document.getElementById(id).value = savedValue;
            }
        });
    
        if (startInput.value && endInput.value) {
            calculerPeriode();
        }
    
        // --- LOGIQUE AUTO-COMPLÉTION FIN DE MOIS ---
        startInput.addEventListener('change', function() {
            if (this.value) {
                const dateDebut = new Date(this.value);
                const dernierJour = new Date(dateDebut.getFullYear(), dateDebut.getMonth() + 1, 0);
                
                const year = dernierJour.getFullYear();
                const month = String(dernierJour.getMonth() + 1).padStart(2, '0');
                const day = String(dernierJour.getDate()).padStart(2, '0');
                const dateFinAuto = `${year}-${month}-${day}`;

                endInput.value = dateFinAuto;
                endInput.setAttribute('min', this.value);
                
                // Sauvegarde isolée par UserID
                localStorage.setItem(getStoreKey('id_date_debut'), this.value);
                localStorage.setItem(getStoreKey('id_date_fin'), dateFinAuto);
                
                calculerPeriode();
            }
        });
    
        // 2. SAUVEGARDE & CALCUL (Changements manuels)
        endInput.addEventListener('change', function() {
            localStorage.setItem(getStoreKey('id_date_fin'), this.value);
            calculerPeriode();
        });
    
        // 3. NETTOYAGE : Supprime uniquement les clés de l'utilisateur actuel lors du submit
        document.querySelector('form').addEventListener('submit', function() {
            fields.forEach(id => localStorage.removeItem(getStoreKey(id)));
        });
    
        function calculerPeriode() {
            const start = startInput.value;
            const end = endInput.value;
            
            if (start && end) {
                const d_debut = new Date(start);
                const d_fin = new Date(end);
    
                if (d_fin < d_debut) {
                    endInput.classList.add('border-rose-500', 'ring-rose-500/10');
                    submitBtn.disabled = true;
                    submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    return; 
                } else {
                    endInput.classList.remove('border-rose-500', 'ring-rose-500/10');
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
                
                const diffTime = Math.abs(d_fin - d_debut);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                
                const typeSelect = document.getElementById('id_periode_type');
                
                if (diffDays <= 31) typeSelect.value = 'mensuel';
                else if (diffDays <= 62) typeSelect.value = 'bimestriel';
                else typeSelect.value = 'trimestriel';
                
                let dateLimite = new Date(d_fin.getFullYear(), d_fin.getMonth() + 1, 15);
                
                document.getElementById('id_date_limite').value = dateLimite.toISOString().split('T')[0];
                document.getElementById('id_annee').value = d_fin.getFullYear();
            }
        }
    });
</script>
{% endblock %}

