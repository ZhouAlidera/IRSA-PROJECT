{% extends 'base_tailwind.html' %}
{% block content %}
{% include 'partials/header.html' %}

<style>
    /* Floating Labels CSS */
    .floating-group { position: relative; width: 100%; }
    .floating-label {
        position: absolute;
        left: 1rem;
        top: 1.1rem;
        transition: all 0.2s ease;
        pointer-events: none;
        color: #94a3b8;
        font-weight: 700;
        text-transform: uppercase;
        font-size: 0.65rem;
    }
    input:focus ~ .floating-label,
    input:not(:placeholder-shown) ~ .floating-label {
        top: 0.35rem;
        font-size: 0.55rem;
        color: #4f46e5;
    }
    input { padding-top: 1.4rem !important; padding-bottom: 0.6rem !important; }
    
    /* Animation de succès interne au modal */
    .success-ring { ring: 4px solid #10b981 !important; transition: all 0.3s; }
</style>

<div id="toast" class="fixed top-5 right-5 transform translate-x-full transition-all duration-500 z-[100] opacity-0">
    <div class="bg-emerald-500 text-white px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-4 border-b-4 border-emerald-700">
        <div class="bg-white/20 rounded-full p-1">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
        </div>
        <div>
            <p class="font-black uppercase text-[10px] tracking-widest opacity-80">Système</p>
            <p class="font-bold text-sm">Employé enregistré avec succès !</p>
        </div>
    </div>
</div>

<div class="max-w-6xl mx-auto px-4 py-8">
    <div class="bg-indigo-50 p-6 rounded-[2rem] mb-8 flex justify-between items-center border border-indigo-100 shadow-sm">
        <div>
            <p class="text-[10px] font-black uppercase tracking-widest text-indigo-400">Saisie Manuelle Détaillée</p>
            <span class="text-indigo-700 font-black uppercase text-sm italic">Période : {{ periode.date_debut|slice:":7" }}</span>
        </div>
        <button type="button" onclick="openModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-3 rounded-2xl text-xs font-black uppercase shadow-lg shadow-indigo-200 transition-all active:scale-95">
            + Ajouter un employé
        </button>
    </div>

    <div class="overflow-x-auto bg-white rounded-[2.5rem] border border-slate-200 shadow-sm">
        <table class="w-full text-left border-collapse">
            <thead>
                <tr class="bg-slate-50/50 border-b border-slate-100 text-[10px] font-black uppercase text-slate-400">
                    <th class="p-6">Employé & Fonction</th>
                    <th class="p-6 text-right">Brut + Avantages</th>
                    <th class="p-6 text-right w-48 text-indigo-600">IRSA Net Final</th>
                    <th class="p-6 w-20"></th>
                </tr>
            </thead>
            <tbody id="employeeTableBody" class="divide-y divide-slate-50">
                {% for emp in employes_deja_saisis %}
                <tr data-db-id="{{ emp.id }}" class="hover:bg-slate-50/80 transition-all group duration-300">
                    <td class="p-6">
                        <span class="block text-slate-900 font-black uppercase text-xs">{{ emp.nom_prenom }}</span>
                        <span class="text-[9px] text-slate-400 font-bold uppercase italic tracking-tighter">{{ emp.fonction }}</span>
                    </td>
                    <td class="p-6 text-right font-bold text-slate-600">
                        {{ emp.remuneration_brute|add:emp.avantages_nature }} Ar
                        <input type="hidden" name="val_brut" value="{{ emp.remuneration_brute }}">
                    </td>
                    <td class="p-6 text-right font-black text-indigo-600">{{ emp.impot_net }} Ar</td>
                    <td class="p-6 text-right">
                        <button type="button" onclick="deleteFromDB({{ emp.id }}, this)" class="opacity-0 group-hover:opacity-100 p-2 text-slate-300 hover:text-rose-500 transition-all">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-width="2" stroke-linecap="round"/></svg>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="mt-8 p-8 bg-slate-900 rounded-[2.5rem] text-white flex justify-between items-center shadow-2xl">
        <div class="flex gap-12">
            <div><p class="text-[10px] uppercase opacity-40 font-black mb-1">Total Salariés</p><p id="totalCount" class="text-2xl font-black italic text-emerald-400">0</p></div>
            <div><p class="text-[10px] uppercase opacity-40 font-black mb-1">Masse Salariale</p><p id="totalMasse" class="text-2xl font-black italic">0 Ar</p></div>
        </div>
        <a href="{% url 'convertir_en_brouillon_SM' %}" class="bg-emerald-500 hover:bg-emerald-400 px-12 py-5 rounded-2xl font-black uppercase text-xs tracking-[0.2em] shadow-xl transition-all">Terminer</a>
    </div>
</div>

<div id="addModal" onclick="checkClose(event)" class="fixed inset-0 bg-slate-900/70 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
    <div id="modalContent" class="bg-white rounded-[2.5rem] max-w-4xl w-full shadow-2xl scale-95 transition-all duration-200 overflow-hidden border-4 border-transparent">
        
        <div class="bg-slate-50 px-8 py-6 border-b border-slate-100 flex justify-between items-center">
            <h2 class="text-xl font-black text-slate-900 italic uppercase">Fiche Nouveau Salarié</h2>
            <button onclick="closeModal()" class="text-slate-400 hover:text-rose-500 transition-colors">✕ Fermer</button>
        </div>

        <div class="p-8 space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="md:col-span-2 floating-group">
                    <input type="text" id="m_nom" placeholder=" " class="w-full bg-slate-50 border-2 border-slate-100 rounded-xl p-4 text-sm font-bold focus:border-indigo-500 outline-none transition-all">
                    <label class="floating-label">Nom & Prénoms</label>
                </div>
                <div class="floating-group">
                    <input type="text" id="m_fonction" placeholder=" " class="w-full bg-slate-50 border-2 border-slate-100 rounded-xl p-4 text-sm font-bold focus:border-indigo-500 outline-none transition-all">
                    <label class="floating-label">Fonction</label>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="floating-group">
                    <input type="text" id="m_cnaps" placeholder=" " class="w-full bg-slate-50 border-2 border-slate-100 rounded-xl p-4 text-sm font-bold outline-none">
                    <label class="floating-label">N° CNaPS</label>
                </div>
                <div class="floating-group">
                    <input type="text" id="m_cin" placeholder=" " class="w-full bg-slate-50 border-2 border-slate-100 rounded-xl p-4 text-sm font-bold outline-none">
                    <label class="floating-label">N° CIN</label>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-indigo-50/50 p-6 rounded-3xl border border-indigo-100">
                <div class="floating-group">
                    <input type="number" id="m_brut" value="0" oninput="liveCalc()" placeholder=" " class="w-full bg-white border-2 border-indigo-200 rounded-xl p-4 text-lg font-black text-indigo-600 outline-none">
                    <label class="floating-label text-indigo-400">Salaire Brut</label>
                </div>
                <div class="floating-group">
                    <input type="number" id="m_avantages" value="0" oninput="liveCalc()" placeholder=" " class="w-full bg-white border-2 border-indigo-200 rounded-xl p-4 text-lg font-black text-indigo-600 outline-none">
                    <label class="floating-label text-indigo-400">Avantages Nature</label>
                </div>
            </div>

            <div class="grid grid-cols-3 gap-4">
                <div class="floating-group"><input type="number" id="m_pension" value="0" placeholder=" " class="w-full bg-slate-50 border-2 border-slate-100 rounded-xl p-4 text-sm font-bold outline-none"><label class="floating-label">CNaPS (1%)</label></div>
                <div class="floating-group"><input type="number" id="m_sante" value="0" placeholder=" " class="w-full bg-slate-50 border-2 border-slate-100 rounded-xl p-4 text-sm font-bold outline-none"><label class="floating-label">Santé (1%)</label></div>
                <div class="floating-group"><input type="number" id="m_enfants" value="0" placeholder=" " class="w-full bg-rose-50 border-2 border-rose-100 rounded-xl p-4 text-sm font-black text-rose-600 outline-none"><label class="floating-label">Nbr Enfants</label></div>
            </div>
        </div>

        <div class="px-8 py-6 bg-slate-50 border-t border-slate-100 flex gap-4">
            <button type="button" onclick="closeModal()" class="px-6 py-4 text-[10px] font-black text-slate-400 uppercase tracking-widest hover:text-slate-600 transition-colors">Annuler</button>
            <div class="flex-1 flex gap-3">
                <button type="button" onclick="addEmployeeToDB(false)" class="flex-1 py-4 bg-indigo-100 text-indigo-700 border-2 border-indigo-200 rounded-2xl text-[10px] font-black uppercase tracking-widest hover:bg-indigo-200 transition-all">Enregistrer & Nouveau</button>
                <button type="button" id="btnSubmit" onclick="addEmployeeToDB(true)" class="flex-1 py-4 bg-slate-900 text-white rounded-2xl text-[10px] font-black uppercase tracking-widest shadow-xl hover:bg-indigo-600 transition-all">Enregistrer & Fermer</button>
            </div>
        </div>
    </div>
</div>

<script>
    window.onload = updateTotals;

    function openModal() {
        document.getElementById('addModal').classList.remove('hidden');
        setTimeout(() => {
            document.getElementById('modalContent').classList.replace('scale-95', 'scale-100');
            document.getElementById('m_nom').focus();
        }, 50);
    }

    function closeModal() {
        document.getElementById('modalContent').classList.replace('scale-100', 'scale-95');
        setTimeout(() => {
            document.getElementById('addModal').classList.add('hidden');
            resetFields();
        }, 200);
    }

    function showToast() {
        const toast = document.getElementById('toast');
        toast.classList.replace('translate-x-full', 'translate-x-0');
        toast.classList.replace('opacity-0', 'opacity-100');
        setTimeout(() => {
            toast.classList.replace('translate-x-0', 'translate-x-full');
            toast.classList.replace('opacity-100', 'opacity-0');
        }, 3000);
    }

    function resetFields() {
        const ids = ['m_nom', 'm_cnaps', 'm_cin', 'm_fonction', 'm_brut', 'm_avantages', 'm_pension', 'm_sante', 'm_enfants'];
        ids.forEach(id => {
            document.getElementById(id).value = (id.includes('nom') || id.includes('cnaps') || id.includes('cin') || id.includes('fonction')) ? "" : 0;
        });
    }

    function checkClose(e) { if(e.target.id === 'addModal') closeModal(); }

    function liveCalc() {
        const brut = parseFloat(document.getElementById('m_brut').value) || 0;
        const avantages = parseFloat(document.getElementById('m_avantages').value) || 0;
        const total = brut + avantages;
        document.getElementById('m_pension').value = Math.floor(Math.min(total * 0.01, 20000));
        document.getElementById('m_sante').value = Math.floor(total * 0.01);
    }

    // --- LOGIQUE DE CALCUL COMPLÈTE (Django Compatible) ---
    function calculateFinalData(brut, avantages, pension, sante, enfants) {
        const rni = Math.floor(brut + avantages - pension - sante);
        let impotBrut = 0;
        
        // Barème Madagascar
        if (rni > 350000) {
            if (rni <= 400000) impotBrut = (rni - 350000) * 0.05;
            else if (rni <= 500000) impotBrut = 2500 + (rni - 400000) * 0.10;
            else if (rni <= 600000) impotBrut = 12500 + (rni - 500000) * 0.15;
            else impotBrut = 27500 + (rni - 600000) * 0.20;
        }

        const reduction = enfants * 2000;
        const impotNet = Math.max(Math.floor(impotBrut - reduction), 2000);

        return { rni, impotBrut: Math.floor(impotBrut), reduction, impotNet };
    }

    async function addEmployeeToDB(shouldClose = true) {
        const btn = document.getElementById('btnSubmit');
        const raw = {
            nom: document.getElementById('m_nom').value,
            cnaps: document.getElementById('m_cnaps').value,
            cin: document.getElementById('m_cin').value,
            fonction: document.getElementById('m_fonction').value,
            brut: parseFloat(document.getElementById('m_brut').value) || 0,
            avantages: parseFloat(document.getElementById('m_avantages').value) || 0,
            pension: parseFloat(document.getElementById('m_pension').value) || 0,
            sante: parseFloat(document.getElementById('m_sante').value) || 0,
            enfants: parseInt(document.getElementById('m_enfants').value) || 0,
        };

        if (!raw.nom || raw.brut <= 0) return alert("Nom et Salaire obligatoires");
        
        btn.disabled = true;
        const calc = calculateFinalData(raw.brut, raw.avantages, raw.pension, raw.sante, raw.enfants);

        let fd = new FormData();
        fd.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        
        // Mapping vers ton modèle Django
        fd.append('nom_prenom', raw.nom);
        fd.append('num_cnaps', raw.cnaps);
        fd.append('cin', raw.cin);
        fd.append('fonction', raw.fonction);
        fd.append('remuneration_brute', raw.brut);
        fd.append('avantages_nature', raw.avantages);
        fd.append('pension', raw.pension);
        fd.append('cotisation_sante', raw.sante);
        fd.append('personnes_charge', raw.enfants);
        
        // Attributs calculés (non nuls)
        fd.append('revenu_net', calc.rni);
        fd.append('impot_brut', calc.impotBrut);
        fd.append('reduction_charge', calc.reduction);
        fd.append('impot_net', calc.impotNet);
        fd.append('revenu_net_theo', calc.rni);
        fd.append('impot_net_theo', calc.impotNet);

        try {
            const response = await fetch("{% url 'ajax_ajouter_employe' %}", { method: 'POST', body: fd });
            const res = await response.json();

            if (res.status === 'success') {
                appendRow(raw.nom, raw.fonction, raw.brut + raw.avantages, calc.impotNet, res.id);
                updateTotals();

                if (shouldClose) {
                    closeModal();
                    showToast();
                } else {
                    const content = document.getElementById('modalContent');
                    content.classList.add('ring-4', 'ring-emerald-400');
                    setTimeout(() => content.classList.remove('ring-4', 'ring-emerald-400'), 400);
                    resetFields();
                    document.getElementById('m_nom').focus();
                }
            }
        } catch (e) { alert("Erreur réseau"); }
        btn.disabled = false;
    }

    function appendRow(nom, fonction, totalBrut, irsa, id) {
        const html = `
            <tr data-db-id="${id}" class="hover:bg-slate-50/80 transition-all group duration-300">
                <td class="p-6">
                    <span class="block text-slate-900 font-black uppercase text-xs">${nom}</span>
                    <span class="text-[9px] text-slate-400 font-bold uppercase italic">${fonction || '---'}</span>
                </td>
                <td class="p-6 text-right font-bold text-slate-600">
                    ${totalBrut.toLocaleString()} Ar
                    <input type="hidden" name="val_brut" value="${totalBrut}">
                </td>
                <td class="p-6 text-right font-black text-indigo-600">${irsa.toLocaleString()} Ar</td>
                <td class="p-6 text-right italic text-slate-300 text-[10px]">ID:${id}</td>
            </tr>`;
        document.getElementById('employeeTableBody').insertAdjacentHTML('afterbegin', html);
    }

    function updateTotals() {
        let masse = 0;
        const rows = document.querySelectorAll('#employeeTableBody tr');
        rows.forEach(row => {
            const val = row.querySelector('input[name="val_brut"]');
            if(val) masse += parseFloat(val.value) || 0;
        });
        document.getElementById('totalMasse').innerText = masse.toLocaleString() + " Ar";
        document.getElementById('totalCount').innerText = rows.length;
    }
</script>
{% endblock %}